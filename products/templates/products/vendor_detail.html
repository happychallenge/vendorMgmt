{% extends "base.html" %}
{% load static %}


{% block title %}
    Vendor Detail - {{ vendor.en_name | upper }} 
{% endblock title %}


{% block css %}
    <link href="{% static 'css/plugins/iCheck/custom.css' %}" rel="stylesheet">
    <link href="{% static 'css/plugins/dataTables/datatables.min.css' %}" rel="stylesheet">
{% endblock css %}


{% block header-index %}
    <h2> Vendor (供应商) </h2>
    <ol class="breadcrumb">
        <li>
            <a href="index.html">Home</a>
        </li>
        <li>
           <a href="{% url 'chemical:vendor_list' %}"> Vendor (供应商) </a>
        </li>
        <li class="active">
            <strong>Detail</strong>
        </li>
    </ol>
{% endblock header-index %}


{% block mainContent %}
    <div class="col-lg-12">
        <div class="ibox float-e-margins">
            <div class="ibox-title">
                <h5> VENDOR (供应商) - {{ vendor.en_name|upper }} </h5>
                <div class="ibox-tools">
                    <a class="collapse-link">
                        <i class="fa fa-chevron-up"></i>
                    </a>
                    <a class="dropdown-toggle" data-toggle="dropdown" href="#">
                        <i class="fa fa-wrench"></i>
                    </a>
                    <ul class="dropdown-menu dropdown-user">
                        <li><a href="#">Config option 1</a></li>
                    </ul>
                </div>
            </div>

            <div class="ibox-content" id="vendorDetail">
                <table class="table table-striped table-bordered">
                    <thead>
                        <tr>
                            <td>ITEM</td>
                            <td>CONTENT</td>
                        </tr>
                    </thead>
                    <tbody>
                        <tr class="gradeX">
                            <td>CHINESE NAME</td>
                            <td>{{ vendor.cn_name }}</td>
                        </tr>
                        <tr>
                            <td>ENGLISH NAME</td>
                            <td>{{ vendor.en_name|upper }}</td>
                        </tr>
                        <tr>
                            <td>CHINESE ADDRESS</td>
                            <td>{{ vendor.cn_address }}</td>
                        </tr>
                        <tr>
                            <td>ENGLISH ADDRESS</td>
                            <td>{{ vendor.en_address|upper }}</td>
                        </tr>
                        <tr>
                            <td>COMPANY TYPE</td>
                            <td>{{ vendor.companytype }}</td>
                        </tr>
                        <tr>
                            <td>STATUS</td>
                            <td>{{ vendor.status }}</td>
                        </tr>
                        <tr>
                            <td>GP RELATIONSHIP</td>
                            <td>{{ vendor.gprelation }}</td>
                        </tr>
                        <tr>
                            <td>TELEPHONE</td>
                            <td>{{ vendor.tel }}</td>
                        </tr>
                        <tr>
                            <td>HOME PAGE</td>
                            <td>
                            {% if vendor.homepage %}
                                 <a href="{{ vendor.homepage }}" target='chem'>{{ vendor.homepage }}</a>
                            {% endif %} 
                            </td>
                        </tr>
                        <tr>
                            <td>TAGS </td>
                            <td class="center"> 
                        {% for tag in vendor.tags.all %}
                            {{ tag }}, 
                        {% endfor %}
                            </td>
                        </tr>
                        <tr>
                            <td>COMMENTS</td>
                            <td>{{ vendor.comments }}</td>
                        </tr>
                    {% if user.is_staff %}
                        <tr> 
                            <td colspan=2> 
                                <!--
                                <button class='btn btn-primary add-product' data-url="{% url 'chemical:ajax_quotation_add' %}?vendor_id={{vendor.id}}"> 
                                    <span class="glyphicon glyphicon-plus"></span> ADD AJAX PRODUCT & QUOTATION  
                                </button>
                                -->

                                <a href="{% url 'chemical:quotation_productadd' %}?vendor_id={{vendor.id}}">
                                    <button class='btn btn-primary' data-url=""> 
                                        <span class="glyphicon glyphicon-plus"></span> ADD PRODUCT & QUOTATION 
                                    </button> 
                                </a>

                                <a href="{% url 'chemical:vendor_update' vendor.id %}"><button class='btn btn-primary pull-right'><span class="glyphicon glyphicon-pencil"></span> EDIT VENDOR</button></a> 
                            </td>
                        </tr>
                    {% endif %}

                    <!-- ######################## -->
                    <!-- QUOTATION LIST OF VENDOR.  -->
                    <!-- ######################## -->
                        <tr><td colspan='2'>
                            <h3>QUOTATION LIST </h3>
                            <table class="table table-striped table-bordered">
                                <thead>
                                    <tr>
                                        <th>NAME </th>
                                        <th>TYPE </th>
                                        <th>QUOTATION <br> PRICE</th>
                                        <th>CURRENCY </th>
                                        <th>PAY TERM</th>
                                        <th>QUOTATION DATE</th>
                                        <th>STATUS</th>
                                        <th> NEW <br> QUOTATION</th>
                                        <th> ACTION </th>
                                    </tr>
                                </thead>
                                <tbody>
                            {% for vendorproduct in vendorproducts %}
                                {% for quotation in vendorproduct.quotation_set.all %}
                                     {% if quotation.status == 'V' %}
                                    <tr>
                                        
                                        <td> {{vendorproduct.product}} </td>
                                        <td> {{vendorproduct.ptype }} </td>
                                        <td style="text-align:right"> {{quotation.price|floatformat:2}}</td>
                                        <td> {{quotation.currency}} </td>
                                        <td> {{quotation.payterm}}</td>
                                        <td> {{quotation.quote_date|date:'Y/m/d'}} </td>
                                        <td> {{quotation.status}} </td>
                                        <td> 
                                        <form action="{% url 'chemical:quotation_simpleadd' %}" method="POST"> 
                                            {% csrf_token %}
                                            <input type="hidden" name="quotation" value="{{quotation.id}}" />   
                                            <input type="hidden" name="vendor" value="{{vendor.id}}" />   
                                            <input type="number" name="newprice" step="any" class="form-control" placeholder="New Price" title="" required id="id_newprice" /> 
                                         
                                            <button type="submit" class="btn btn-primary">SIMPLE</button> 
                                        </form>
                                        </td>
                                        <td>
                                            <a href="{% url 'chemical:quotation_update' %}?quotation={{quotation.id}}">
                                                <button type="button" class="btn btn-primary">UPDATE</button>
                                            </a>
                                        </td>
                                    </tr>
                                    {% endif %}
                                {% endfor %}
                            {% endfor %}    

                                </tbody>
                            </table></td> <!-- QUOTATION LIST -->
                        </tr>


                    <!-- ######################## -->
                    <!-- PRODUCT LIST OF VENDOR.  -->
                    <!-- ######################## -->
                        <tr><td colspan='2'>
                            <h3>PRODUCT & QUOTATION HISTORY </h3>
                            <table class="table table-striped table-bordered">
                                <thead>
                                    <tr>
                                        <th>Name </th>
                                        <th>CAS No.</th>
                                        <th>Category</th>
                                        <th>HSCODE(china)<br>korea</th>
                                        <th>TAX <br> REFUND(%)</th>
                                        <th>CREATED AT</th>
                                    </tr>
                                </thead>
                                <tbody>
                                {% for vendorProduct in  vendor.vendorproduct_set.all %}
                                    <tr>
                                        <td>
                                            <a href="{% url 'chemical:product_detail' vendorProduct.product.id %}">{{vendorProduct.product.en_name|upper}} <br> {{ vendorProduct.product.cn_name }}
                                            </a> 
                                        </td>
                                        <td>{{ vendorProduct.product.cas_no}}</td>
                                        <td>{{ vendorProduct.product.category }}</td>
                                        <td>
                                            {{ vendorProduct.product.cn_hscode }} <br> 
                                            {{vendorProduct.product.ko_hscode}} 
                                        </td>
                                        <td>{{ vendorProduct.product.rate_taxrefund }}</td>
                                        <td>{{ vendorProduct.created_at }}</td>
                                    </tr>
                                    <tr>
                                        <td colspan='6'>
                                        <!-- ######################## -->
                                        <!-- QUOTATION LIST -->
                                        <!-- ######################## -->
                                            <table class="table table-striped table-bordered">
                                                <thead>
                                                    <tr>
                                                        <th>ID </th>
                                                        <th>TYPE </th>
                                                        <th>QUOTATION PRICE</th>
                                                        <th>CURRENCY </th>
                                                        <th>PAY TERM</th>
                                                        <th>QUOTATION DATE</th>
                                                        <th>EFFIVE DATE</th>
                                                        <th>STATUS</th>
                                                        <th>COMMENT</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                {% for quotation in vendorProduct.quotation_set.all %}
                                                    <tr class='sub{% if quotation.status == 'I' %} invlid{% endif %}'>
                                                        <td> {{forloop.counter }} </td>
                                                        <td> {{vendorProduct.ptype}}</td>
                                                        <td style="text-align:right"> {{quotation.price|floatformat:2}}</td>
                                                        <td> {{quotation.currency}} </td>
                                                        <td> {{quotation.payterm}}</td>
                                                        <td> {{quotation.quote_date|date:'Y/m/d'}} </td>
                                                        <td> {{quotation.effective_date|date:'Y/m/d'}} </td>
                                                        <td> {{quotation.status}} </td>
                                                        <td> {{quotation.comment}} </td>
                                                    </tr>
                                                {% endfor %}
                                                </tbody>
                                            </table></td>
                                            <!-- QUOTATION LIST -->
                                        </td>
                                    </tr>
                                {% endfor %}

                                </tbody>
                            </table>
                            <!-- PRODUCT LIST OF vendor -->
                        </tr>
                    <!-- ######################## -->
                    <!-- CONTACT LIST OF VENDOR.  -->
                    <!-- ######################## -->
                        <tr><td colspan='2'>
                            <h3>CONTACT LIST </h3>
                            <table class="table table-striped table-bordered">
                                <thead>
                                    <tr>
                                        <th>Name </th>
                                        <th>ROLE</th>
                                        <th>MOBILE</th>
                                        <th>EMAIL</th>
                                        <th>WECHAT</th>
                                    </tr>
                                </thead>
                                <tbody>
                                {% for contact in  vendor.contact_set.all %}
                                    <tr>
                                        <td>
                                            <a href="{% url 'chemical:contact_update' contact.id %}"> 
                                                {{ contact.cn_name }} - {{ contact.en_name }}
                                            </a>
                                        </td>
                                        <td>{{ contact.role }}</td>
                                        <td>{{ contact.mobile }}</td>
                                        <td>{{ contact.email }}</td>
                                        <td>{{ contact.wechat }}</td>
                                    </tr>
                                {% endfor %}
                                </tbody>
                            </table>
                        {% if user.is_staff %}
                            <a href="{% url 'chemical:contact_add' %}">
                                <button class='btn btn-primary'>
                                    <span class="glyphicon glyphicon-plus"></span> ADD CONTACT</button>
                            </a> 
                        {% endif %}
                            </td>
                            <!-- PRODUCT LIST OF vendor -->
                        </tr>

                    </tbody>
                </table> 
                <!-- vendor -->
            </div> <!-- class="ibox-content" -->

        </div> <!-- class="ibox float-e-margins" -->
    </div> <!-- class="col-lg-12" -->
    
    <!-- ######################## -->
    <!-- AJAX PRODUCT INPUT MODAL  -->
    <!-- ######################## -->
    <div class="modal fade" id="modalProduct">
        <div class="modal-dialog">
            <div class="modalContent">
                
            </div>
        </div>
    </div>

{% endblock mainContent %}



{% block javascript %}

    <style>
        tr.invlid { color:#b5cedf; }
    </style>

    <script src="{% static 'js/plugins/dataTables/datatables.min.js' %}"></script>

    <!-- Custom and plugin javascript -->

    <script>
        $(function(){
            var loadForm = function(){
                var btn = $(this);
                $.ajax({
                    url : btn.attr('data-url'),
                    type : 'get',
                    dataType : 'json',
                    beforeSend: function(){
                        $('#modalProduct').modal('show');
                    },
                    success: function(data) {
                        $('#modalProduct .modalContent').html(data.html_form)
                    }
                });
            }

            var saveForm = function(){
                var form = $(this);
                $.ajax({
                    url : from.attr('action'),
                    data : form.serialize(),
                    type : from.attr('method'),
                    dataType : 'json',
                    success : function(data) {
                        if (data.form_is_valid) {
                            $('#vendorDetail').html(data.html_quotation);
                            $('#modalProduct').modal('hide');
                        } else {
                            $('#modalProduct .modalContent').html(data.html_form)
                        }
                    },
                    error:function(request,status,error) {
                        alert("code:"+request.status+"\n"+"message:"+request.responseText+"\n"+"error:"+error);
                    }
                });
                return false;
            }

            $('.add-product').click(loadForm);
            $('#modalProduct').on("submit", ".quotation_form", saveForm);
            
        })
    </script>

{% endblock javascript %}

</body>

</html>
