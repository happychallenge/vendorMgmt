{% extends "base.html" %}
{% load static %}


{% block title %}
    SOURCING Detail - {{ vendor.en_name | upper }} 
{% endblock title %}


{% block css %}
    <link href="{% static 'css/plugins/iCheck/custom.css' %}" rel="stylesheet">
    <link href="{% static 'css/plugins/dataTables/datatables.min.css' %}" rel="stylesheet">
{% endblock css %}


{% block header-index %}
    <h2> SOURCING (供应商) </h2>
    <ol class="breadcrumb">
        <li>
            <a href="index.html">Home</a>
        </li>
        <li>
           <a href="{% url 'chemical:vendor_list' %}"> SOURCING (供应商) </a>
        </li>
        <li class="active">
            <strong>Detail</strong>
        </li>
    </ol>
{% endblock header-index %}


{% block mainContent %}
    <div class="col-lg-12">
        <div class="ibox float-e-margins">
            <div class="ibox-title">
                <h5> SOURCING (供应商) - {{ vendor.en_name|upper }} </h5>
                <div class="ibox-tools">
                    <a class="collapse-link">
                        <i class="fa fa-chevron-up"></i>
                    </a>
                    <a class="dropdown-toggle" data-toggle="dropdown" href="#">
                        <i class="fa fa-wrench"></i>
                    </a>
                    <ul class="dropdown-menu dropdown-user">
                        <li><a href="#">Config option 1</a></li>
                    </ul>
                </div>
            </div>

            <div class="ibox-content" id="vendorDetail">
                <table class="table table-striped table-bordered">
                    <thead>
                        <tr>
                            <td>ITEM</td>
                            <td>CONTENT</td>
                        </tr>
                    </thead>
                    <tbody>
                        {% include 'products/partial/vendor_detail.html' %}
                    {# 관리자를 위한 등록 버턴 #}
                     {% if user.is_staff %} 
                        <tr> 
                            <td colspan=2> 
                                <a href="{% url 'chemical:sourcing_productadd' %}?vendor_id={{vendor.id}}">
                                    <button class='btn btn-primary' data-url=""> 
                                        <span class="glyphicon glyphicon-plus"></span> ADD PRODUCT & SOURCING 
                                    </button> 
                                </a>
                                <a href="{% url 'chemical:vendor_update' vendor.id %}">
                                    <button class='btn btn-primary pull-right'><span class="glyphicon glyphicon-pencil"></span> EDIT VENDOR</button>
                                </a> 
                            </td>
                        </tr>
                    {% endif %}

                    <!-- ######################## -->
                    <!-- QUOTATION LIST OF VENDOR.  -->
                    <!-- ######################## -->
                        <tr>
                            <td colspan='2'>
                            <h3>QUOTATION LIST </h3>
                            {% include 'products/partial/s_quotation_list.html' %}
                            </td> <!-- QUOTATION LIST -->
                        </tr>


                    <!-- ######################## -->
                    <!-- PRODUCT LIST OF VENDOR.  -->
                    <!-- ######################## -->
                        <tr><td colspan='2'>
                            <h3>PRODUCT & QUOTATION HISTORY </h3>
                            <table class="table table-striped table-bordered">
                                <thead>
                                    <tr>
                                        <th>Name </th>
                                        <th>CAS No.</th>
                                        <th>Category</th>
                                        <th>HSCODE(china)<br>korea</th>
                                        <th>TAX <br> REFUND(%)</th>
                                        <th>CREATED AT</th>
                                    </tr>
                                </thead>
                                <tbody>
                                {% for vendorProduct in  vendor.vendorproduct_set.all %}
                                    <tr>
                                        <td>
                                            <a href="{% url 'chemical:sourcingvendor_detail' vendorProduct.product.id %}">{{vendorProduct.product.en_name|upper}} <br> {{ vendorProduct.product.cn_name }}
                                            </a> 
                                        </td>
                                        <td>{{ vendorProduct.product.cas_no}}</td>
                                        <td>{{ vendorProduct.product.category }}</td>
                                        <td>
                                            {{ vendorProduct.product.cn_hscode }} <br> 
                                            {{vendorProduct.product.ko_hscode}} 
                                        </td>
                                        <td>{{ vendorProduct.product.rate_taxrefund }}</td>
                                        <td>{{ vendorProduct.created_at }}</td>
                                    </tr>
                                    <tr>
                                        <td colspan='6'>
                                        <!-- ######################## -->
                                        <!-- QUOTATION LIST -->
                                        <!-- ######################## -->
                                            <table class="table table-striped table-bordered">
                                                <thead>
                                                    <tr>
                                                        <th>ID </th>
                                                        <th>TYPE </th>
                                                        <th>BUYING <br> PRICE</th>
                                                        <th>USD <br> PRICE </th>
                                                        <th>PAY TERM</th>
                                                        <th>QUOTATION DATE</th>
                                                        <th>EFFIVE DATE</th>
                                                        <th>STATUS</th>
                                                        <th>COMMENT</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                {% for sourcing in vendorProduct.sourcing_set.all %}
                                                    <tr class='sub{% if sourcing.status == 'I' %} invlid{% endif %}'>
                                                        <td> {{forloop.counter }} </td>
                                                        <td> {{vendorProduct.ptype}}</td>
                                                        <td style="text-align:right"> {{sourcing.buying_price|floatformat:2}}</td>
                                                        <td style="text-align:right"> {{sourcing.usd_price|floatformat:2}}</td>
                                                        <td> {{sourcing.payterm}}</td>
                                                        <td> {{sourcing.quote_date|date:'Y/m/d'}} </td>
                                                        <td> {{sourcing.effective_date|date:'Y/m/d'}} </td>
                                                        <td> {{sourcing.status}} </td>
                                                        <td> {{sourcing.comment}} </td>
                                                    </tr>
                                                {% empty %} {# 견적이 없는 경우 추가를 함 #}
                                                    <tr>
                                                        <td colspan='9'> 
                                                            <a href="{% url 'chemical:sourcing_priceadd' %}?vendorproduct={{vendorProduct.id}}">
                                                                <button class='btn btn-primary'> 
                                                                    <span class="glyphicon glyphicon-plus"></span> ADD RMB QUOTATION 
                                                                </button> 
                                                            </a>
                                                        </td>
                                                    </tr>
                                                {% endfor %}

                                                </tbody>
                                            </table></td>
                                            <!-- QUOTATION LIST -->
                                        </td>
                                    </tr>
                                {% endfor %}
                                </tbody>
                            </table>
                            <!-- PRODUCT LIST OF vendor -->
                        </tr>
                    <!-- ######################## -->
                    <!-- CONTACT LIST OF VENDOR.  -->
                    <!-- ######################## -->
                        <tr>
                            <td colspan='2'>
                                <h3>CONTACT LIST </h3>
                                {% include 'products/partial/ajax_contact_list.html' with contact_list=vendor.contact_set.all %}
                            </td>
                            <!-- PRODUCT LIST OF vendor -->
                        </tr>
    
                        <tr>
                            <td colspan='2'>
                                <h3>COMMENTS </h3>
                                <div class="vendorComment">
                                    {% include 'products/partial/ajax_comment_list.html' with comment_list=vendor.comment_set.all %}
                                </div>
                            </td>
                            <!-- PRODUCT LIST OF vendor -->
                        </tr>
                    </tbody>
                </table> 
                <!-- vendor -->
            </div> <!-- class="ibox-content" -->

        </div> <!-- class="ibox float-e-margins" -->
    </div> <!-- class="col-lg-12" -->
    
    <!-- ######################## -->
    <!-- AJAX PRODUCT INPUT MODAL  -->
    <!-- ######################## -->
    <div class="modal fade" id="modalComment">
        <div class="modal-dialog">
            <div class="modalContent">
                
            </div>
        </div>
    </div>

{% endblock mainContent %}



{% block javascript %}

    <style>
        tr.invlid { color:#b5cedf; }
    </style>

    <script src="{% static 'js/plugins/dataTables/datatables.min.js' %}"></script>

    <!-- Custom and plugin javascript -->

    <script>
        $(function(){
            var loadForm = function(){
                var btn = $(this);
                $.ajax({
                    url : btn.attr('data-url'),
                    type : 'get',
                    dataType : 'json',
                    beforeSend: function(){
                        $('#modalComment').modal('show');
                    },
                    success: function(data) {
                        $('#modalComment .modalContent').html(data.html_form)
                    }
                });
            }

            var saveForm = function(){
                var form = $(this);
                $.ajax({
                    url: form.attr("action"),
                    data : form.serialize(),
                    type : form.attr('method'),
                    dataType : 'json',
                    success : function(data) {
                        if (data.form_is_valid) {
                            $('.vendorComment').html(data.html_result);
                            $('#modalComment').modal('hide');
                        } else {
                            $('#modalComment .modalContent').html(data.html_form)
                        }
                    },
                });
                return false;
            }

            $('.add-comment').click(loadForm);
            $('#modalComment').on("submit", ".add-comment-form", saveForm);
            
            $(".vendorComment").on("click", ".update-comment", loadForm);
            $("#modalComment").on("submit", ".update-comment-form", saveForm);
        })
    </script>

{% endblock javascript %}

</body>

</html>
